#!/bin/bash


source /etc/init.d/base
source /etc/mqtt-send.conf

MQTT_TOPIC="units/chameleon/${BOARD_SN}/sys_info"


function prepare_payload() {
    cpu_usage=$(top -d1 -bn2 | grep '^CPU:' | tail -n1 | tr -s ' ' | cut -d ' ' -f 2,4 | tr -d '%' | tr ' ' + | bc)
    mem_info=($(free -m | grep '^Mem:' | tr -s ' ' | cut -d ' ' -f 2,3))
    storage_info=($(df -m /data | tail -n 1 | tr -s ' ' | cut -d ' ' -f 2,3))
    temperature=$(echo $(cat /sys/class/thermal/thermal_zone0/temp)/1000 | bc)
    miner_height=$(/opt/miner/bin/miner info height | tr '\t' ' ' | tr -s ' ' | cut -d ' ' -f 2)
    miner_listen_addr=$(/opt/miner/bin/miner peer book -s | grep listen_addrs -A2 | tail -n1 | tr -d '|')
    test $? == 0 || miner_height="null"
    uptime=$(cat /proc/uptime | grep -oE '^[[:digit:]]+')
    test -r /sys/class/net/eth0/address && eth_mac=$(cat /sys/class/net/eth0/address)
    test -r /sys/class/net/wlan0/address && wlan_mac=$(cat /sys/class/net/wlan0/address)
    ecc_sn=$(cat /var/run/ecc_sn)
    pub_key=$(cat /var/run/public_key_hex)
    hotspot_name=$(cat /var/run/hotspot_name)

    payload="{
        \"cpu_usage\":${cpu_usage},
        \"mem_used\":${mem_info[1]},
        \"mem_total\":${mem_info[0]},
        \"storage_used\":${storage_info[1]},
        \"storage_total\":${storage_info[0]},
        \"temperature\":${temperature},
        \"miner_height\":${miner_height},
        \"miner_listen_addr\":\"${miner_listen_addr}\",
        \"hotspot_name\":\"${hotspot_name}\",
        \"fw_version\":\"${OS_VERSION}\",
        \"ecc_sn\":\"${ecc_sn}\",
        \"pub_key\":\"${pub_key}\",
        \"eth_mac\":\"${eth_mac}\",
        \"wlan_mac\":\"${wlan_mac}\",
        \"uptime\":${uptime}
    }"

    payload=$(echo ${payload} | tr -d '\t\n ')
    echo "${payload}"
}

test -f /var/run/hotspot_name || exit 0  # Miner not started yet

payload=$(prepare_payload)
mosquitto_pub -h ${MQTT_BROKER_HOST} -p ${MQTT_BROKER_PORT} -t ${MQTT_TOPIC} -m "${payload}" -i ${BOARD_SN}
